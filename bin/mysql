#!/usr/bin/env bash
# bin/mysql â€” run mysql client inside the DB container
set -euo pipefail

# shellcheck source=bin/_docker_helpers.sh
. "$(cd "$(dirname "$0")" && pwd)/_docker_helpers.sh"

: "${MYSQL_SERVICE:=mysql}"
: "${MYSQL_DATABASE:=sdmc}"

# Read root password from host secret (preferred)
PW_FILE="$(grep -E '^MYSQL_ROOT_PASSWORD_FILE_HOST=' "$ENV_FILE" | cut -d= -f2- | tr -d '"')"
if [[ -n "${PW_FILE:-}" && -r "$PW_FILE" ]]; then
  MYSQL_PW="$(<"$PW_FILE")"
else
  echo "ERROR: MYSQL_ROOT_PASSWORD_FILE_HOST not set/readable in .env" >&2
  exit 1
fi

# Ensure service is up
dc up -d "$MYSQL_SERVICE" >/dev/null 2>&1 || true

# Run the mysql client inside the container
# Usage: bin/mysql [extra mysql args...]  (defaults to DB=$MYSQL_DATABASE)
exec dc exec -T \
  -e MYSQL_PWD="$MYSQL_PW" \
  "$MYSQL_SERVICE" \
  mysql -uroot ${MYSQL_DATABASE:+"$MYSQL_DATABASE"} "$@"

